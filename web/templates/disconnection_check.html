{% extends "base.html" %}

{% block title %}단선확인{% endblock %}

{% block head %}
    {{ super() }}
    <style>
        .image-container {
            border: 1px solid #ccc;
            padding: 10px;
            margin-bottom: 20px;
            background-color: #f9f9f9;
            border-radius: 8px;
        }
        .image-container img {
            max-width: 100%;
            height: auto;
            display: block;
            margin-top: 10px;
            border-radius: 4px;
        }
        .detection-status {
            font-weight: bold;
            margin-top: 10px;
            padding: 5px;
            border-radius: 4px;
            display: inline-block;
        }
        .status-detected {
            background-color: #ffe0e0; /* Light red */
            color: #d32f2f; /* Dark red */
        }
        .status-not-detected {
            background-color: #e0ffe0; /* Light green */
            color: #388e3c; /* Dark green */
        }
        .process-button {
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .process-button:hover {
            background-color: #0056b3;
        }
        #loading-indicator {
            display: none;
            margin-top: 10px;
            font-style: italic;
            color: #555;
        }
    </style>
{% endblock %}

{% block content %}
    <h1>단선확인</h1>
    <p>이 페이지에서는 지정된 디렉토리의 이미지들을 분석하여 단선 여부를 확인합니다.</p>

    <button class="process-button" onclick="processImages()">이미지 분석 시작</button>
    <div id="loading-indicator">이미지 분석 중... 잠시만 기다려 주세요.</div>
    <div id="results-container">
        <!-- Analysis results will be displayed here -->
    </div>

    <script>
        async function processImages() {
            const resultsContainer = document.getElementById('results-container');
            const loadingIndicator = document.getElementById('loading-indicator');
            resultsContainer.innerHTML = ''; // Clear previous results
            loadingIndicator.style.display = 'block'; // Show loading indicator

            try {
                const response = await fetch('/api/process_disconnection_images', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                const data = await response.json();

                loadingIndicator.style.display = 'none'; // Hide loading indicator

                if (response.ok) {
                    if (data.message) { // Handle case with no images found
                        resultsContainer.innerHTML = `<p>${data.message}</p>`;
                    } else {
                        data.forEach(result => {
                            const imageContainer = document.createElement('div');
                            imageContainer.className = 'image-container';

                            const filenameEl = document.createElement('h3');
                            filenameEl.textContent = `파일: ${result.filename}`;
                            imageContainer.appendChild(filenameEl);

                            if (result.image_data) {
                                const imgEl = document.createElement('img');
                                imgEl.src = `data:image/jpeg;base64,${result.image_data}`;
                                imgEl.alt = `Processed ${result.filename}`;
                                imageContainer.appendChild(imgEl);
                            } else {
                                const errorEl = document.createElement('p');
                                errorEl.style.color = 'red';
                                errorEl.textContent = `이미지 처리 실패: ${result.message}`;
                                imageContainer.appendChild(errorEl);
                            }

                            const statusEl = document.createElement('p');
                            statusEl.className = 'detection-status';
                            if (result.disconnection_detected) {
                                statusEl.classList.add('status-detected');
                                statusEl.textContent = '단선 감지됨 (0.9 이상)';
                            } else {
                                statusEl.classList.add('status-not-detected');
                                statusEl.textContent = '단선 감지 안됨';
                            }
                            imageContainer.appendChild(statusEl);

                            resultsContainer.appendChild(imageContainer);
                        });
                    }
                } else {
                    resultsContainer.innerHTML = `<p style="color: red;">오류 발생: ${data.error || '알 수 없는 오류'}</p>`;
                }
            } catch (error) {
                loadingIndicator.style.display = 'none'; // Hide loading indicator
                resultsContainer.innerHTML = `<p style="color: red;">네트워크 오류 또는 서버 응답 문제: ${error.message}</p>`;
                console.error('Error processing images:', error);
            }
        }
    </script>
{% endblock %}
